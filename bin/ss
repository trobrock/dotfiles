#!/usr/bin/env bash

set -e

source "$(dirname "$0")/lib/logging.sh"

get_machine_name() {
  if [ ! -f .machine_name ]; then
    names=$(op --account=robrock.1password.com item get "ZSH Secrets" --format json | jq -r '.sections[].label')
    echo "Available machine names:"
    select machine_name in $names; do
      if [ -n "$machine_name" ]; then
        echo "Selected machine name: $machine_name"
        break
      else
        echo "Invalid selection, please try again."
      fi
    done
    echo $machine_name > .machine_name
  fi

  cat .machine_name
}

backup_secrets() {
  if [ -f $HOME/.zsh_secrets ]; then
    mv $HOME/.zsh_secrets $HOME/.zsh_secrets.bak
    rm -f $HOME/.zsh_secrets
  fi
}

install_secrets() {
  log "Installing secrets.zsh from 1password..."
  if [ -z "$(command -v op)" ] || ( ! op vault list > /dev/null 2>&1 ); then
    log_error "1Password CLI (op) is not installed. Please install it first."
  else
    backup_secrets

    # grab all the secrets from the "common" section and write them to the file
    op --account=robrock.1password.com item get "ZSH Secrets" --format json | jq -r ".fields[] | select(.section.label == \"common\") | \"\(.label) \(.value)\"" | while read -r line; do
      label=$(echo "$line" | cut -d' ' -f1)
      value=$(echo "$line" | cut -d' ' -f2-)
      echo "export $label=\"$value\"" >> $HOME/.zsh_secrets
    done

    section=$(get_machine_name)

    # grab all the secrets from that section and write them to the file
    op --account=robrock.1password.com item get "ZSH Secrets" --format json | jq -r ".fields[] | select(.section.label == \"$section\") | \"\(.label) \(.value)\"" | while read -r line; do
      label=$(echo "$line" | cut -d' ' -f1)
      value=$(echo "$line" | cut -d' ' -f2-)
      echo "export $label=\"$value\"" >> $HOME/.zsh_secrets
    done
  fi
}

# Only run when executed directly, not when sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  install_secrets
fi
